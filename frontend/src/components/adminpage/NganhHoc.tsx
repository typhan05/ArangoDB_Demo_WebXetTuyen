import React, { useEffect, useState, useMemo } from "react";
import { Button } from "../ui/button";
import CapNhatChuyenNganh from "./Details/CapNhatChuyenNganh";
// import "./NganhHoc.css";

interface NganhHoc {
  MaNganhHoc: number;
  TenNganhHoc: string;
  DiemDau: number;
  DiemTHPTQG?: number;
  DiemHocBa?: number;
  DiemDGNL?: number;
  TrangThai: number;
  ChuyenNganh?: boolean;
}

interface KhoiXetTuyen {
  MaKhoi: string;
  TenMon: string[];
}

interface ChuyenNganh {
  MaChuyenNganh: number;
  TenChuyenNganh: string;
  KhoiXetTuyen?: string[];
}

const KhoiXetTuyenDetail: React.FC<{
  maNganh: number; // MaNganhHoc
  khoiXetTuyenData: Record<number, KhoiXetTuyen[]>;
  onBack: () => void;
}> = ({ maNganh, khoiXetTuyenData, onBack }) => {
  const [maKhoiCu, setMaKhoiCu] = useState(""); // M√£ kh·ªëi c≈© mu·ªën ƒë·ªïi
  const [maKhoiMoi, setMaKhoiMoi] = useState(""); // M√£ kh·ªëi m·ªõi nh·∫≠p v√†o
  const [message, setMessage] = useState("");

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    if (!maKhoiCu || !maKhoiMoi) {
      setMessage("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ kh·ªëi c≈© v√† m√£ kh·ªëi m·ªõi.");
      return;
    }

    try {
      const response = await fetch(
        `http://localhost:8000/cap-nhat-khoi-nganh/${maNganh}/${maKhoiCu}`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ MaKhoiMoi: maKhoiMoi }),
        }
      );

      if (!response.ok) {
        const errorData = await response.json();
        setMessage(`L·ªói: ${errorData.detail || "C·∫≠p nh·∫≠t th·∫•t b·∫°i"}`);
        return;
      }

      const data = await response.json();
      setMessage(data.message || "C·∫≠p nh·∫≠t th√†nh c√¥ng!");
    } catch (error) {
      setMessage(
        "L·ªói khi g·ªçi API: " +
          (error instanceof Error ? error.message : String(error))
      );
    }
  };

  return (
    <div>
      <button onClick={onBack} style={{ marginBottom: "10px" }}>
        üîô Quay l·∫°i danh s√°ch ng√†nh
      </button>

      <h4>
        Kh·ªëi x√©t tuy·ªÉn c·ªßa ng√†nh{" "}
        <span className="text-blue-600 font-bold">{maNganh}</span>
      </h4>

      {khoiXetTuyenData[maNganh]?.length > 0 ? (
        <div className="overflow-auto max-w-full max-h-[48vh]">
          <table className="w-full">
            <thead>
              <tr>
                <th>M√£ Kh·ªëi</th>
                <th>M√¥n h·ªçc</th>
                <th>Ch·ªçn l√†m kh·ªëi c≈©</th>
                <th>X√≥a</th>
              </tr>
            </thead>
            <tbody>
              {khoiXetTuyenData[maNganh].map((khoi, index) => (
                <tr key={index}>
                  <td>{khoi.MaKhoi}</td>
                  <td>
                    <ul>
                      {khoi.TenMon.map((mon, idx) => (
                        <li key={idx}>{mon}</li>
                      ))}
                    </ul>
                  </td>
                  <td>
                    <button
                      onClick={() => setMaKhoiCu(khoi.MaKhoi)}
                      className={
                        maKhoiCu === khoi.MaKhoi
                          ? "bg-blue-500 text-white px-2 py-1 rounded"
                          : "bg-gray-200 px-2 py-1 rounded"
                      }
                    >
                      {maKhoiCu === khoi.MaKhoi ? "ƒêang ch·ªçn" : "Ch·ªçn"}
                    </button>
                  </td>
                  <td>
                    <button className="text-red-500">üóë X√≥a</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <p>‚è≥ ƒêang t·∫£i m√¥n h·ªçc ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu...</p>
      )}
      <div className="shadow-md rounded-2xl px-5 py-4 bg-white">
        <h3 className="font-bold text-lg mb-3">
          ‚ûï C·∫≠p nh·∫≠t M√£ Kh·ªëi X√©t Tuy·ªÉn
        </h3>

        <form onSubmit={handleSubmit}>
          <div className="flex gap-4 mb-4">
            <div>
              <label className="block mb-1">
                M√£ kh·ªëi c≈© (ch·ªçn ·ªü tr√™n ho·∫∑c nh·∫≠p l·∫°i):
              </label>
              <input
                className="border rounded-md px-2 py-1"
                type="text"
                value={maKhoiCu}
                onChange={(e) => setMaKhoiCu(e.target.value)}
                required
                placeholder="M√£ kh·ªëi c≈©"
              />
            </div>
            <div>
              <label className="block mb-1">M√£ kh·ªëi m·ªõi:</label>
              <input
                className="border rounded-md px-2 py-1"
                type="text"
                value={maKhoiMoi}
                onChange={(e) => setMaKhoiMoi(e.target.value)}
                required
                placeholder="M√£ kh·ªëi m·ªõi"
              />
            </div>
          </div>

          <Button
            type="submit"
            variant="secondary"
            className="bg-blue-500 hover:bg-blue-800 text-white"
          >
            C·∫≠p nh·∫≠t m√£ kh·ªëi
          </Button>
        </form>
      </div>

      {message && <p>{message}</p>}
    </div>
  );
};

const ChuyenNganhDetail: React.FC<{
  maNganh: number;
  chuyenNganhData: Record<number, ChuyenNganh[]>;
  onBack: () => void;
  onReload: () => void;
}> = ({ maNganh, chuyenNganhData, onBack, onReload }) => {
  const [maChuyenNganh, setMaChuyenNganh] = useState("");
  const [tenChuyenNganh, setTenChuyenNganh] = useState("");
  const [message, setMessage] = useState("");
  const [isAdding, setIsAdding] = useState(true); // tr·∫°ng th√°i Th√™m m·ªõi hay C·∫≠p nh·∫≠t

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    if (!maChuyenNganh || !tenChuyenNganh) {
      setMessage(
        "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ chuy√™n ng√†nh v√† t√™n chuy√™n ng√†nh m·ªõi"
      );
      return;
    }

    try {
      let response;
      if (isAdding) {
        // G·ª≠i POST t·∫°o m·ªõi chuy√™n ng√†nh theo ng√†nh h·ªçc
        response = await fetch(
          `http://localhost:8000/api/nganh-hoc/${maNganh}/create-chuyen-nganh`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              MaChuyenNganh: Number(maChuyenNganh),
              TenChuyenNganh: tenChuyenNganh,
            }),
          }
        );
      } else {
        // G·ª≠i PUT c·∫≠p nh·∫≠t chuy√™n ng√†nh
        response = await fetch(
          `http://localhost:8000/cap-nhat-chuyen-nganh/${maChuyenNganh}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ TenChuyenNganh: tenChuyenNganh }),
          }
        );
      }

      if (!response.ok) {
        const errorData = await response.json();
        setMessage(
          `L·ªói: ${errorData.detail || errorData.error || "Thao t√°c th·∫•t b·∫°i"}`
        );
        return;
      }

      const data = await response.json();
      setMessage(data.message || "Thao t√°c th√†nh c√¥ng!");
      setMaChuyenNganh("");
      setTenChuyenNganh("");
      onReload();
      // C√≥ th·ªÉ th√™m code ƒë·ªÉ refresh d·ªØ li·ªáu chuy√™n ng√†nh n·∫øu c·∫ßn
    } catch (error) {
      setMessage(
        "L·ªói khi g·ªçi API: " +
          (error instanceof Error ? error.message : String(error))
      );
    }
  };

  return (
    <div>
      <Button
        onClick={onBack}
        style={{ marginBottom: "10px" }}
        variant="outline"
      >
        üîô Quay l·∫°i danh s√°ch ng√†nh
      </Button>
      <h4 className="font-bold">Chuy√™n ng√†nh c·ªßa ng√†nh {maNganh}</h4>

      {chuyenNganhData[maNganh]?.length > 0 ? (
        <table>
          <thead>
            <tr>
              <th>STT</th>
              <th>T√™n chuy√™n ng√†nh</th>
              <th>M√£ chuy√™n ng√†nh</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            {chuyenNganhData[maNganh].map((chuyen, index) => (
              <tr key={chuyen.MaChuyenNganh}>
                <td>{index + 1}</td>
                <td>{chuyen.TenChuyenNganh}</td>
                <td>{chuyen.MaChuyenNganh}</td>
                <td>
                  <button className="text-red-500" type="button">
                    üóë X√≥a
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      ) : (
        <p className="my-10 p-4 border">
          ‚è≥ ƒêang t·∫£i chuy√™n ng√†nh ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu...
        </p>
      )}

      <div className="shadow-md rounded-2xl px-5 py-4 bg-white">
        <h3 className="font-bold text-lg mb-3">
          ‚ûï Th√™m / C·∫≠p nh·∫≠t Chuy√™n Ng√†nh
        </h3>

        <form onSubmit={handleSubmit}>
          <div className="flex gap-4 mb-4">
            <div>
              <label className="block mb-1">M√£ chuy√™n ng√†nh:</label>
              <input
                className="border rounded-md px-2 py-1"
                type="number"
                value={maChuyenNganh}
                onChange={(e) => setMaChuyenNganh(e.target.value)}
                required
              />
            </div>
            <div>
              <label className="block mb-1">T√™n chuy√™n ng√†nh:</label>
              <input
                className="border rounded-md px-2 py-1"
                type="text"
                value={tenChuyenNganh}
                onChange={(e) => setTenChuyenNganh(e.target.value)}
                required
              />
            </div>
          </div>

          <div className="flex gap-4 mb-6">
            <label>
              <input
                type="radio"
                name="actionType"
                checked={isAdding}
                onChange={() => setIsAdding(true)}
              />{" "}
              Th√™m m·ªõi chuy√™n ng√†nh
            </label>{" "}
            <label>
              <input
                type="radio"
                name="actionType"
                checked={!isAdding}
                onChange={() => setIsAdding(false)}
              />{" "}
              C·∫≠p nh·∫≠t chuy√™n ng√†nh
            </label>
          </div>

          <Button
            type="submit"
            variant="secondary"
            className="bg-blue-500 hover:bg-blue-800 text-white"
          >
            {isAdding ? "Th√™m chuy√™n ng√†nh" : "C·∫≠p nh·∫≠t chuy√™n ng√†nh"}
          </Button>
        </form>
      </div>

      {message && <p className="mt-4 text-green-800">{message}</p>}
    </div>
  );
};

const NganhHoc: React.FC = () => {
  const [nganhHocList, setNganhHocList] = useState<NganhHoc[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [isProcessing, setIsProcessing] = useState(false);
  const [khoiXetTuyenData, setKhoiXetTuyenData] = useState<
    Record<number, KhoiXetTuyen[]>
  >({});
  const [chuyenNganhData, setChuyenNganhData] = useState<
    Record<number, ChuyenNganh[]>
  >({});
  const [viewingKhoi, setViewingKhoi] = useState<number | null>(null);
  const [viewingChuyenNganh, setViewingChuyenNganh] = useState<number | null>(
    null
  );
  const [newNganh, setNewNganh] = useState({
    MaNganhHoc: "",
    TenNganhHoc: "",
    DiemDau: "",
  });
  const [editMode, setEditMode] = useState<{
    isEditing: boolean;
    editedNganh?: NganhHoc;
  }>({
    isEditing: false,
  });

  useEffect(() => {
    fetchData();
  }, []);
  const [editedNganh, setEditedNganh] = React.useState<NganhHoc | null>(null);

  React.useEffect(() => {
    if (editMode.isEditing && editMode.editedNganh) {
      setEditedNganh(editMode.editedNganh);
    } else {
      setEditedNganh(null);
    }
  }, [editMode]);
  const fetchData = async () => {
    setLoading(true);
    try {
      const response = await fetch("http://localhost:8000/nganh-hoc");
      if (!response.ok) {
        throw new Error("L·ªói khi t·∫£i d·ªØ li·ªáu ng√†nh h·ªçc");
      }
      const data = await response.json();
      setNganhHocList(data || []);
    } catch (err) {
      console.error("L·ªói khi t·∫£i ng√†nh h·ªçc:", err);
      setError("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng√†nh h·ªçc.");
    } finally {
      setLoading(false);
    }
  };

  const loadKhoiXetTuyen = async (maNganh: number) => {
    if (khoiXetTuyenData[maNganh]) {
      setViewingKhoi(maNganh);
      return;
    }

    try {
      const response = await fetch(
        `http://localhost:8000/mon-hoc-theo-nganh?ma_nganh=${maNganh}`
      );
      if (!response.ok) {
        throw new Error(`L·ªói khi t·∫£i m√¥n h·ªçc cho ng√†nh ${maNganh}`);
      }
      const data = await response.json();

      const khoiMonHocMap: KhoiXetTuyen[] = [];
      data.forEach((item: any) => {
        item.KhoiXetTuyen.forEach((khoi: any) => {
          const tenMonList = khoi.MonHocs.map((mon: any) => mon.TenMonHoc);
          khoiMonHocMap.push({
            MaKhoi: khoi.MaKhoi,
            TenMon: tenMonList,
          });
        });
      });

      setKhoiXetTuyenData((prev) => ({
        ...prev,
        [maNganh]: khoiMonHocMap,
      }));

      setViewingKhoi(maNganh);
    } catch (err) {
      console.error(`L·ªói khi t·∫£i m√¥n h·ªçc cho ng√†nh ${maNganh}:`, err);
      setKhoiXetTuyenData((prev) => ({
        ...prev,
        [maNganh]: [],
      }));
      setViewingKhoi(maNganh);
    }
  };

  const loadChuyenNganh = async (maNganh: number, forceReload = false) => {
    // N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu v√† kh√¥ng y√™u c·∫ßu reload l·∫°i th√¨ tr·∫£ v·ªÅ lu√¥n
    if (!forceReload && chuyenNganhData[maNganh]) {
      setViewingChuyenNganh(maNganh);
      return;
    }

    try {
      const response = await fetch(
        `http://localhost:8000/chuyen-nganh-theo-nganh?ma_nganh=${maNganh}`
      );
      if (!response.ok) {
        throw new Error(`L·ªói khi t·∫£i chuy√™n ng√†nh cho ng√†nh ${maNganh}`);
      }
      const data = await response.json();

      const chuyenNganhList: ChuyenNganh[] = data.map((item: any) => ({
        MaChuyenNganh: item.MaChuyenNganh,
        TenChuyenNganh: item.TenChuyenNganh,
      }));

      setChuyenNganhData((prev) => ({
        ...prev,
        [maNganh]: chuyenNganhList,
      }));

      setViewingChuyenNganh(maNganh);
    } catch (err) {
      console.error(`L·ªói khi t·∫£i chuy√™n ng√†nh cho ng√†nh ${maNganh}:`, err);
      setChuyenNganhData((prev) => ({
        ...prev,
        [maNganh]: [],
      }));
      setViewingChuyenNganh(maNganh);
    }
  };

  const handleReload = () => {
    if (viewingChuyenNganh !== null) {
      loadChuyenNganh(viewingChuyenNganh, true); // G·ªçi v·ªõi forceReload=true ƒë·ªÉ t·∫£i l·∫°i d·ªØ li·ªáu
    }
  };

  const handleStatusChange = async (maNganhHoc: number, checked: boolean) => {
    setIsProcessing(true);
    try {
      const response = await fetch(
        `http://localhost:8000/nganh-hoc/${maNganhHoc}/trang-thai`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ TrangThai: checked ? 1 : 0 }),
        }
      );
      if (!response.ok) {
        throw new Error("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ng√†nh h·ªçc");
      }
      setNganhHocList((prev) =>
        prev.map((nganh) =>
          nganh.MaNganhHoc === maNganhHoc
            ? { ...nganh, TrangThai: checked ? 1 : 0 }
            : nganh
        )
      );
    } catch (err) {
      alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ng√†nh h·ªçc.");
    } finally {
      setIsProcessing(false);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setEditedNganh((prev) => (prev ? { ...prev, [name]: value } : null));
  };

  const handleSaveEdit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    if (!editedNganh) return;

    const MaNganhHoc = Number(editedNganh.MaNganhHoc);
    const TenNganhHoc = editedNganh.TenNganhHoc?.trim() || "";
    const DiemDau = Number(editedNganh.DiemDau);
    const DiemTHPTQG =
      String(editedNganh.DiemTHPTQG ?? "") === ""
        ? null
        : Number(editedNganh.DiemTHPTQG);
    const DiemDGNL =
      String(editedNganh.DiemDGNL ?? "") === ""
        ? null
        : Number(editedNganh.DiemDGNL);

    if (!MaNganhHoc || !TenNganhHoc || isNaN(DiemDau)) {
      alert(
        "Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin M√£ ng√†nh, T√™n ng√†nh v√† ƒêi·ªÉm ƒë·∫ßu h·ª£p l·ªá!"
      );
      return;
    }

    const data = {
      MaNganhHoc,
      TenNganhHoc,
      DiemDau,
      DiemTHPTQG,
      DiemDGNL,
    };

    try {
      const res = await fetch(`http://localhost:8000/api/update-nganh-hoc`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (res.status === 404) {
        alert("Ng√†nh h·ªçc kh√¥ng t·ªìn t·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t");
        return;
      }

      if (res.status >= 400) {
        const errorData = await res.json();
        alert("L·ªói: " + (errorData.error || "C√≥ l·ªói khi c·∫≠p nh·∫≠t"));
        return;
      }

      const resData = await res.json();

      alert(resData.message || "C·∫≠p nh·∫≠t th√†nh c√¥ng!");
      setEditMode({ isEditing: false });
      fetchData();
      // C√≥ th·ªÉ g·ªçi l·∫°i API l·∫•y danh s√°ch m·ªõi ho·∫∑c c·∫≠p nh·∫≠t state danh s√°ch ·ªü ƒë√¢y
    } catch (err) {
      console.error("Error:", err);
      alert("C√≥ l·ªói x·∫£y ra khi g·ªçi API");
    }
  };

  const handleDelete = async (maNganhHoc: number) => {
    const confirmation = window.confirm(
      "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng√†nh h·ªçc n√†y?"
    );
    if (confirmation) {
      setIsProcessing(true);
      try {
        const response = await fetch(
          `http://localhost:8000/nganh-hoc/${maNganhHoc}`,
          {
            method: "DELETE",
          }
        );
        if (!response.ok) {
          throw new Error("L·ªói khi x√≥a ng√†nh h·ªçc");
        }
        setNganhHocList((prev) =>
          prev.filter((nganh) => nganh.MaNganhHoc !== maNganhHoc)
        );
      } catch (err) {
        alert("Kh√¥ng th·ªÉ x√≥a ng√†nh h·ªçc.");
      } finally {
        setIsProcessing(false);
      }
    }
  };

  const handleAddNganh = async (e: React.FormEvent) => {
    e.preventDefault();

    const nganhToSubmit = {
      ...newNganh,
      MaBacHoc: 1, // Ho·∫∑c t√πy ch·ªânh t·ª´ props/state
      TrangThai: 1,
    };

    try {
      const response = await fetch("http://localhost:8000/api/nganh-hoc", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(nganhToSubmit),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || "L·ªói khi th√™m ng√†nh h·ªçc");
      }

      fetchData(); // Re-fetch the data to update the list
      setNewNganh({ MaNganhHoc: "", TenNganhHoc: "", DiemDau: "" });
    } catch (error) {
      console.error("L·ªói:", error);
      if (error instanceof Error) {
        alert(error.message);
      } else {
        alert("ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.");
      }
    }
  };

  const filteredList = useMemo(
    () =>
      nganhHocList.filter(
        (nganh) =>
          String(nganh.MaNganhHoc)
            .toLowerCase()
            .includes(searchTerm.toLowerCase()) ||
          nganh.TenNganhHoc.toLowerCase().includes(searchTerm.toLowerCase())
      ),
    [nganhHocList, searchTerm]
  );

  // Add this function before the return statement
  const handleEdit = (nganh: NganhHoc) => {
    console.log(nganh);
    setEditMode({ isEditing: true, editedNganh: nganh });
  };

  return (
    <div className="relative h-full">
      <h2 className="font-bold">üìö Danh s√°ch Ng√†nh h·ªçc</h2>

      {viewingKhoi !== null ? (
        <KhoiXetTuyenDetail
          maNganh={viewingKhoi}
          khoiXetTuyenData={khoiXetTuyenData}
          onBack={() => setViewingKhoi(null)}
        />
      ) : viewingChuyenNganh !== null ? (
        <ChuyenNganhDetail
          maNganh={viewingChuyenNganh}
          chuyenNganhData={chuyenNganhData}
          onBack={() => setViewingChuyenNganh(null)}
          onReload={handleReload}
        />
      ) : (
        <>
          <input
            type="text"
            placeholder="üîç T√¨m ki·∫øm m√£ ng√†nh ho·∫∑c t√™n ng√†nh..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            style={{
              padding: "8px",
              width: "300px",
              borderRadius: "4px",
              border: "1px solid #ccc",
              marginBottom: "10px",
            }}
          />
          {loading ? (
            <p>‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>
          ) : error ? (
            <p style={{ color: "red" }}>{error}</p>
          ) : (
            <div className="overflow-auto max-w-full max-h-[50vh]">
              <table className="w-full">
                <colgroup>
                  <col className="w-[15%]" />
                  <col className="w-[35%]" />
                  <col className="w-[10%]" />
                  <col className="w-[10%]" />
                  <col className="w-[30%]" />
                </colgroup>
                <thead>
                  <tr>
                    <th>M√£ Ng√†nh</th>
                    <th>T√™n Ng√†nh</th>
                    {/* <th>ƒêi·ªÉm ƒêGNL</th>
                    <th>ƒêi·ªÉm THPTQG</th> */}
                    <th>ƒêi·ªÉm H·ªçc B·∫°</th>
                    <th>Tr·∫°ng Th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredList
                    .slice()
                    .reverse()
                    .map((nganh) => (
                      <tr key={nganh.MaNganhHoc}>
                        <td>{nganh.MaNganhHoc}</td>
                        <td>{nganh.TenNganhHoc}</td>
                        {/* <td>{nganh.DiemDGNL ?? "‚Äî"}</td>
                      <td>{nganh.DiemDau}</td> */}
                        <td>{nganh.DiemDau}</td>

                        <td>
                          <input
                            type="checkbox"
                            checked={nganh.TrangThai === 1}
                            disabled={isProcessing}
                            onChange={(e) =>
                              handleStatusChange(
                                nganh.MaNganhHoc,
                                e.target.checked
                              )
                            }
                          />
                        </td>

                        <td>
                          <div className="flex gap-2">
                            <button
                              onClick={() => loadKhoiXetTuyen(nganh.MaNganhHoc)}
                            >
                              üìò Kh·ªëi
                            </button>
                            <button
                              onClick={() => loadChuyenNganh(nganh.MaNganhHoc)}
                            >
                              üß≠ Chuy√™n ng√†nh
                            </button>
                            <button onClick={() => handleEdit(nganh)}>
                              ‚úèÔ∏è S·ª≠a
                            </button>
                            <button
                              onClick={() => handleDelete(nganh.MaNganhHoc)}
                            >
                              üóë X√≥a
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                </tbody>
              </table>
            </div>
          )}

          {editMode.isEditing && editedNganh ? (
            <form
              onSubmit={handleSaveEdit}
              className="edit-form absolute bottom-0 -left-5 right-0 shadow-md rounded-2xl px-5 py-4 bg-white"
            >
              <h3 className="font-bold text-lg mb-3">üìù Ch·ªânh s·ª≠a Ng√†nh h·ªçc</h3>
              <div className="flex flex-wrap gap-2">
                <input
                  className="border rounded-md px-2 py-1"
                  type="text"
                  name="MaNganhHoc"
                  value={editedNganh.MaNganhHoc}
                  readOnly
                />
                <input
                  className="border rounded-md px-2 py-1"
                  type="text"
                  name="TenNganhHoc"
                  value={editedNganh.TenNganhHoc}
                  onChange={handleInputChange}
                  placeholder="T√™n ng√†nh"
                />
                <input
                  className="border rounded-md px-2 py-1"
                  type="number"
                  name="DiemDau"
                  value={editedNganh.DiemDau}
                  onChange={handleInputChange}
                  placeholder="ƒêi·ªÉm ƒë·∫ßu"
                />
                {/* <input
                  className="border rounded-md px-2 py-1"
                  type="number"
                  name="DiemTHPTQG"
                  value={editedNganh.DiemTHPTQG ?? ""}
                  onChange={handleInputChange}
                  placeholder="ƒêi·ªÉm THPTQG"
                />
                <input
                  className="border rounded-md px-2 py-1"
                  type="number"
                  name="DiemDGNL"
                  value={editedNganh.DiemDGNL ?? ""}
                  onChange={handleInputChange}
                  placeholder="ƒêi·ªÉm ƒêGNL"
                /> */}
                <Button type="submit" variant="outline">
                  üíæ L∆∞u
                </Button>
                <Button
                  type="submit"
                  variant="outline"
                  onClick={() => {
                    setEditMode({ isEditing: false });
                    setNewNganh({
                      MaNganhHoc: "",
                      TenNganhHoc: "",
                      DiemDau: "",
                    });
                  }}
                >
                  ‚ùå H·ªßy
                </Button>
              </div>
            </form>
          ) : (
            <form
              onSubmit={handleAddNganh}
              className="edit-form absolute bottom-0 -left-5 right-0 w-full shadow-md rounded-2xl px-5 py-4 bg-white"
            >
              <h3 className="font-bold text-lg mb-3">‚ûï Th√™m Ng√†nh h·ªçc m·ªõi</h3>
              <div className="flex gap-2">
                <input
                  type="text"
                  name="MaNganhHoc"
                  maxLength={7}
                  className="border rounded-md px-2 py-1"
                  placeholder="M√£ ng√†nh h·ªçc"
                  required
                  value={newNganh.MaNganhHoc}
                  onChange={(e) =>
                    setNewNganh({ ...newNganh, MaNganhHoc: e.target.value })
                  }
                />

                <input
                  type="text"
                  name="TenNganhHoc"
                  className="border rounded-md px-2 py-1"
                  placeholder="T√™n ng√†nh h·ªçc"
                  required
                  value={newNganh.TenNganhHoc}
                  onChange={(e) =>
                    setNewNganh({ ...newNganh, TenNganhHoc: e.target.value })
                  }
                />

                <input
                  type="number"
                  name="DiemDau"
                  className="border rounded-md px-2 py-1"
                  placeholder="ƒêi·ªÉm ƒë·∫ßu"
                  required
                  value={newNganh.DiemDau}
                  onChange={(e) =>
                    setNewNganh({ ...newNganh, DiemDau: e.target.value })
                  }
                />
                <Button type="submit" className="bg-blue-600 hover:bg-blue-800">
                  Th√™m ng√†nh
                </Button>
              </div>
            </form>
          )}
        </>
      )}
    </div>
  );
};

export default NganhHoc;
